<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name=viewport content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
  
<title>Sketch Pad</title>
<script src="scripts/canvas/sketcher/smooth.js"></script>
<script src="scripts/helpers.js"></script>
<script src="scripts/jquery-1.10.2.min.js"></script>
<!--<script src="scripts/canvas/kinetic-v4.7.0.min.js"></script>-->
<script src="scripts/farbtastic.min.js"></script>

<script src="scripts/canvas/sketcher/classes/SketchPad.js"></script>
<script src="scripts/canvas/sketcher/classes/MarkerMaker.js"></script>
<script src="scripts/canvas/sketcher/classes/WallDrawing.js"></script>
<script src="scripts/canvas/sketcher/classes/WallSegment.js"></script>


<link rel="stylesheet" href="styles/bootstrap.css" />
<link rel="stylesheet" href="styles/styles.css" />
<link rel="stylesheet" href="styles/farbtastic.css" />
<style>

#color_swatch{
  width:30px;
  height:30px;
  background-color:black;
  position:absolute;
  top:5px;
  right:80px;
  border:1px solid gray;
}

#sketch{
  margin-top:100px;
  margin-bottom: 100px;
}

.drag_button{
  width:30px;
  height:30px;
  background-color:black;
  position:absolute;
  top:5px;
  right:120px;
  border: 1px solid gray;
}

.drag_button img{
  width: inherit;
  height: inherit;
  
}

.grab {
  cursor: -webkit-grab;
  cursor: -moz-grab;
}

.grabbing { 
  cursor: -webkit-grabbing;
  cursor: -moz-grabbing; 
}

.tool-selected{
  border:1px solid orange;
}

</style>

<script>
var sketcher = null;
var brush = null;
var wallDrawing;
var canvas;
var mousePressed = false;
var prevMousePos;
var dragToolEnabled = false;

function hideMenus() {
  $('#colorpicker').hide();
}

function installBrush(img, color) {
  brush = new MarkerMaker(img, color);
  sketcher.brush = brush;
  sketcher.renderFunction = sketcher.updateCanvasByBrush;
}

function setColor(color) {
  installBrush(sketcher.brush, color);
  $('#color_swatch').css('background-color',color);
}

function getMousePos(canvas, evt) {
  var rect = canvas.getBoundingClientRect();
  return {
    x: evt.clientX - rect.left,
    y: evt.clientY - rect.top
  };
}

function bindEvents(){

     //color picker bindings
     var fb = $.farbtastic('#colorpicker',setColor);
     $('#colorpicker').hide();
     $('#color_swatch').click(function(){ 
        sketcher.context.globalCompositeOperation = 'source-over';
        hideMenus();
        $('#colorpicker').toggle();
     });

     //drag bindings
    $(".drag_button").click(function(){
        sketcher.setEnabled(dragToolEnabled); //this is done before the toggle
        dragToolEnabled = !dragToolEnabled;
        
        $('#sketch').toggleClass('grab');
        $(this).toggleClass('tool-selected');
    });

    canvas.addEventListener('mousemove', function(evt) {
        if(mousePressed){

          var currentMousePos = getMousePos(canvas, evt);

          if(dragToolEnabled){ //dragging...
            wallDrawing.drag(prevMousePos.x, currentMousePos.x);
          }else{ //drawing...
            wallDrawing.notifyNeedsUpdate(prevMousePos.x, currentMousePos.x);
          }
          prevMousePos = currentMousePos;
        }          
    }, false);

    canvas.addEventListener('mousedown', function(evt){
        mousePressed = true;
        prevMousePos = getMousePos(canvas, evt);

        if(dragToolEnabled){
          $('canvas').toggleClass('grabbing', true);
        }
    }, false);

    canvas.addEventListener('mouseup', function(evt){
        
        if(dragToolEnabled){
          $('canvas').toggleClass('grabbing', false);
        }else{ //save images
          wallDrawing.updateImages();
        }
        mousePressed = false;
    }, false);
}

$(document).ready(function(e) {
	
    canvas = $("#sketch")[0];
	  sketcher = new SketchPad("sketch", $("#default-brush-image")[0]);
    sketcher.preOnCanvasMouseDown = function(){
       hideMenus();
    }

    wallDrawing = new WallDrawing(canvas, 400);

    bindEvents();

    setTimeout(function(){wallDrawing.display()},500);
});

</script>

</head>

<body>
<div class="topbar-wrapper" style="z-index: 5;">
    <div class="topbar" data-dropdown="dropdown">
      <div class="topbar-inner">
        <div class="container">
          <h3><a href="#">Wall Sketcher</a></h3>
          <img id="default-brush-image" visibility="hidden" src="images/sketcher/tip3.png">
  
          <ul class="nav secondary-nav">
             <div class="drag_button">
              <img src="images/hand_icon.png">
             </div>
             <div id="color_swatch"></div>
             <div id="colorpicker" style="position:absolute;"></div>
          </ul>
        </div>
      </div><!-- /topbar-inner -->
    </div><!-- /topbar -->
  </div>
  <div class="canvas-container">
    <canvas id="sketch" width="960" height="512" />
  </div>
</body>
</html>
